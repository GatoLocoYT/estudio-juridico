<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel | Consultas</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>

<body class="bg-slate-50 text-slate-800 antialiased min-h-screen">
  <!-- Top bar -->
  <header class="border-b border-slate-200 bg-white sticky top-0 z-40">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-amber-100 border border-amber-200 flex items-center justify-center">
          <span class="text-amber-700 font-semibold">JL</span>
        </div>
        <div class="leading-tight">
          <div class="font-semibold text-slate-900">Panel de Abogados</div>
          <div class="text-sm text-slate-500">Consultas</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="hidden sm:flex flex-col text-right leading-tight">
          <div id="whoName" class="text-sm font-semibold text-slate-900">—</div>
          <div id="whoRole" class="text-xs text-slate-500">—</div>
        </div>

        <button id="btnLogout"
          class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100">
          Cerrar sesión
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-6">
    <!-- Breadcrumb / status -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Consultas recibidas</h1>
        <p class="text-sm text-slate-500">Listado operativo. Seleccioná una consulta para ver el detalle.</p>
      </div>

      <div class="flex items-center gap-2">
        <div id="pillCount"
          class="rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-700">
          —
        </div>
        <div id="pillUpdated"
          class="rounded-full bg-blue-50 border border-blue-100 px-3 py-1 text-xs font-semibold text-blue-700">
          —
        </div>
      </div>
    </div>

    <!-- Filters -->
    <section class="mt-6 rounded-3xl border border-slate-200 bg-white shadow-sm p-5">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="text-xs text-slate-600">Buscar</label>
          <input id="q"
            class="mt-1 w-full rounded-xl bg-white border border-slate-300 px-3 py-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
            placeholder="Nombre, email, área..." />
        </div>

        <div>
          <label class="text-xs text-slate-600">Estado</label>
          <select title="estado" id="status"
            class="mt-1 w-full rounded-xl bg-white border border-slate-300 px-3 py-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            <option value="">Todos</option>
            <option value="new">Nueva</option>
            <option value="review">En revisión</option>
            <option value="answered">Respondida</option>
            <option value="closed">Cerrada</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-slate-600">Urgencia</label>
          <select title="urgencia" id="urgency"
            class="mt-1 w-full rounded-xl bg-white border border-slate-300 px-3 py-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            <option value="">Todas</option>
            <option value="high">Alta</option>
            <option value="medium">Media</option>
            <option value="low">Baja</option>
          </select>
        </div>

        <div class="flex items-end gap-2">
          <button id="btnRefresh"
            class="w-full rounded-xl bg-blue-700 px-4 py-2 text-white font-semibold hover:bg-blue-600 transition">
            Actualizar
          </button>
          <button id="btnClear"
            class="rounded-xl border border-slate-300 bg-white px-4 py-2 font-semibold text-slate-700 hover:bg-slate-100">
            Limpiar
          </button>
        </div>
      </div>
    </section>

    <section class="mt-6 grid lg:grid-cols-3 gap-6 items-start">
      <!-- Table -->
      <div class="lg:col-span-2 rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
          <div class="font-semibold text-slate-900">Listado</div>
          <div id="tableMsg" class="text-sm text-slate-500"></div>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr class="text-left text-slate-600">
                <th class="px-5 py-3 font-semibold">Cliente</th>
                <th class="px-5 py-3 font-semibold">Área</th>
                <th class="px-5 py-3 font-semibold">Estado</th>
                <th class="px-5 py-3 font-semibold">Urgencia</th>
                <th class="px-5 py-3 font-semibold">Fecha</th>
              </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
      </div>

      <!-- Detail -->
      <aside class="rounded-3xl border border-slate-200 bg-white shadow-sm p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-500">Detalle</div>
            <div id="dTitle" class="text-lg font-semibold text-slate-900">Seleccioná una consulta</div>
          </div>
          <div id="dBadges" class="flex flex-wrap justify-end gap-2"></div>
        </div>

        <div id="dBody" class="mt-4 text-sm text-slate-600">
          Para ver información, hacé clic en una fila del listado.
        </div>

        <div class="mt-6 border-t border-slate-200 pt-4">
          <div class="text-xs text-slate-500">Acciones (próximo paso)</div>
          <div class="mt-2 text-sm text-slate-600">
            En V1: ver detalle. Luego agregamos cambiar estado, asignar y notas.
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    // ===== Utils =====
    const $ = (sel, root = document) => root.querySelector(sel);

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtDate(iso) {
      if (!iso) return "—";
      try {
        const d = new Date(iso);
        return d.toLocaleString("es-AR", { dateStyle: "short", timeStyle: "short" });
      } catch { return iso; }
    }

    function pill(text, kind) {
      const base = "inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold border";
      const map = {
        blue:   "bg-blue-50 border-blue-100 text-blue-700",
        green:  "bg-green-50 border-green-100 text-green-700",
        amber:  "bg-amber-50 border-amber-100 text-amber-700",
        red:    "bg-red-50 border-red-100 text-red-700",
        slate:  "bg-slate-100 border-slate-200 text-slate-700",
      };
      return `<span class="${base} ${map[kind] || map.slate}">${esc(text)}</span>`;
    }

    function mapStatus(s) {
      if (s === "new") return { label: "Nueva", kind: "blue" };
      if (s === "review") return { label: "En revisión", kind: "amber" };
      if (s === "answered") return { label: "Respondida", kind: "green" };
      if (s === "closed") return { label: "Cerrada", kind: "slate" };
      return { label: s || "—", kind: "slate" };
    }

    function mapUrgency(u) {
      if (u === "high") return { label: "Alta", kind: "red" };
      if (u === "medium") return { label: "Media", kind: "amber" };
      if (u === "low") return { label: "Baja", kind: "green" };
      return { label: u || "—", kind: "slate" };
    }

    async function api(url, opts) {
      const res = await fetch(url, opts);
      const json = await res.json().catch(() => null);
      if (!res.ok) {
        const msg = (json && (json.error || json.message)) || `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return json;
    }

    // ===== Auth gate =====
    async function ensureAuth() {
      try {
        const me = await api("/api/admin/me");
        $("#whoName").textContent = me.user.full_name;
        $("#whoRole").textContent = me.user.role;
      } catch (_) {
        window.location.href = "/admin/login.html";
      }
    }

    // ===== Data =====
    let all = [];
    let filtered = [];
    let selectedId = null;

    function applyFilters() {
      const q = $("#q").value.trim().toLowerCase();
      const status = $("#status").value;
      const urgency = $("#urgency").value;

      filtered = all.filter((c) => {
        const hay = `${c.full_name} ${c.email} ${c.area} ${c.status} ${c.urgency}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (status && c.status !== status) return false;
        if (urgency && c.urgency !== urgency) return false;
        return true;
      });

      $("#pillCount").textContent = `${filtered.length} consultas`;
      renderRows();
      if (selectedId) renderDetail(selectedId);
    }

    function renderRows() {
      const tbody = $("#rows");
      if (!filtered.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-5 py-10 text-center text-slate-500">
              No hay resultados con los filtros actuales.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map((c) => {
        const st = mapStatus(c.status);
        const ur = mapUrgency(c.urgency);
        const active = c.id === selectedId ? "bg-blue-50/60" : "hover:bg-slate-50";
        return `
          <tr class="cursor-pointer ${active}" data-id="${c.id}">
            <td class="px-5 py-3">
              <div class="font-semibold text-slate-900">${esc(c.full_name)}</div>
              <div class="text-xs text-slate-500">${esc(c.email)}${c.phone ? " · " + esc(c.phone) : ""}</div>
            </td>
            <td class="px-5 py-3 text-slate-700">${esc(c.area)}</td>
            <td class="px-5 py-3">${pill(st.label, st.kind)}</td>
            <td class="px-5 py-3">${pill(ur.label, ur.kind)}</td>
            <td class="px-5 py-3 text-slate-600">${fmtDate(c.created_at)}</td>
          </tr>
        `;
      }).join("");

      // bind click
      tbody.querySelectorAll("tr[data-id]").forEach((tr) => {
        tr.addEventListener("click", () => {
          selectedId = Number(tr.getAttribute("data-id"));
          renderRows();
          renderDetail(selectedId);
        });
      });
    }

    function renderDetail(id) {
      const c = all.find(x => x.id === id);
      if (!c) return;

      $("#dTitle").textContent = c.full_name || "Detalle";

      const st = mapStatus(c.status);
      const ur = mapUrgency(c.urgency);
      $("#dBadges").innerHTML = `
        ${pill(st.label, st.kind)}
        ${pill(ur.label, ur.kind)}
      `;

      const assigned = c.assigned_name ? esc(c.assigned_name) : "Sin asignar";

      $("#dBody").innerHTML = `
        <div class="space-y-3">
          <div>
            <div class="text-xs text-slate-500">Email</div>
            <div class="text-sm text-slate-800 font-semibold">${esc(c.email)}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Teléfono</div>
            <div class="text-sm text-slate-800 font-semibold">${c.phone ? esc(c.phone) : "—"}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Área</div>
            <div class="text-sm text-slate-800 font-semibold">${esc(c.area)}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Asignado a</div>
            <div class="text-sm text-slate-800 font-semibold">${assigned}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Fecha</div>
            <div class="text-sm text-slate-800 font-semibold">${fmtDate(c.created_at)}</div>
          </div>
          <div class="pt-2 border-t border-slate-200">
            <div class="text-xs text-slate-500">Mensaje</div>
            <div class="mt-1 whitespace-pre-wrap text-sm text-slate-800 leading-relaxed">${esc(c.message || "—")}</div>
          </div>
        </div>
      `;
    }

    async function loadData() {
      $("#tableMsg").textContent = "Cargando...";
      const data = await api("/api/admin/consultations");
      all = data.consultations || [];
      $("#pillUpdated").textContent = `Actualizado: ${new Date().toLocaleTimeString("es-AR")}`;
      $("#tableMsg").textContent = "";
      applyFilters();
    }

    // ===== Events =====
    $("#q").addEventListener("input", () => applyFilters());
    $("#status").addEventListener("change", () => applyFilters());
    $("#urgency").addEventListener("change", () => applyFilters());

    $("#btnClear").addEventListener("click", () => {
      $("#q").value = "";
      $("#status").value = "";
      $("#urgency").value = "";
      applyFilters();
    });

    $("#btnRefresh").addEventListener("click", () => loadData());

    $("#btnLogout").addEventListener("click", async () => {
      try {
        await api("/api/admin/logout", { method: "POST" });
      } finally {
        window.location.href = "/admin/login.html";
      }
    });

    // ===== Boot =====
    (async () => {
      await ensureAuth();
      await loadData();
    })();
  </script>
</body>
</html>
